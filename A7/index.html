<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Heatmap of Death Rate Change by Region (1999-2017)</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Courier+Prime&family=Dancing+Script:wght@400..700&family=Mr+Dafoe&family=Petit+Formal+Script&display=swap" rel="stylesheet">
</head>
<body>
    <div id="date" style="position: absolute; top: 10px; right: 20px; font-family: 'Courier New', monospace; font-size: 16px;"></div>
    <div style="position:absolute; top: 30px; margin-bottom:50px; left:30px; font-family: 'Courier New', monospace; font-size: 30px;">
       influenza and pneumonia
    </div>
    <svg id="l_chart" width="1400" height="800"></svg>
    <svg id="h_map" width="1400" height="800"></svg>
    <svg id="ml_chart" width="1400" height="900"></svg>
    <svg id="streamgraph" width="1400" height="900"></svg>


    <script type="module">
        import * as d3 from "https://cdn.jsdelivr.net/npm/d3@7/+esm";

        const width = 1400;
        const height = 800;

        const m_left = 100;
        const m_right = 10;
        const m_top = 150;
        const m_bottom = 150;

        const northeast = ["Connecticut", "Maine", "Massachusetts", "New Hampshire", "Rhode Island", "Vermont", "New Jersey", "New York", "Pennsylvania"];
        const midwest = ["Illinois", "Indiana", "Michigan", "Ohio", "Wisconsin", "Iowa", "Kansas", "Minnesota", "Missouri", "Nebraska", "North Dakota", "South Dakota"];
        const south = ["Delaware", "District of Columbia", "Florida", "Georgia", "Maryland", "North Carolina", "South Carolina", "Virginia", "West Virginia", "Alabama", "Kentucky", "Mississippi", "Tennessee", "Arkansas", "Louisiana", "Oklahoma", "Texas"];
        const west = ["Arizona", "Colorado", "Idaho", "Montana", "Nevada", "New Mexico", "Utah", "Wyoming", "Alaska", "California", "Hawaii", "Oregon", "Washington"];

        async function load_data() {
            const data = await d3.csv("./data/cod2.csv");
            const filteredData = data
                .map(d => ({
                    year: parseInt(d.Year),
                    cause: d["Cause Name"],
                    state: d.State,
                    d_rate: parseFloat(d["Age-adjusted Death Rate"])
                }))
                .filter(d => d.year >= 1999 && d.year <= 2017)
                .filter(d => d.cause === "Influenza and pneumonia" && d.state !== "United States" && d.state !== "District of Columbia");

            const regionData = groupByRegion(filteredData);
            plotLineChart(regionData)
            plotHeatmap(regionData)
            plotSmallMultiples(regionData)
             plotStreamgraph(regionData)
        }

        function plotStreamgraph(regionData) {
    const svg = d3.select("#streamgraph");

    // Define SVG dimensions
    const svgWidth = 1400;
    const svgHeight = 600;
    const margin = { top: 40, right: 50, bottom: 100, left: 100 };

    svg.attr("width", svgWidth)
        .attr("height", svgHeight);

    const all_years = [1999, 2000, 2001, 2002, 2003, 2004, 2005, 2006, 2007, 2008, 2009, 2010, 2011, 2012, 2013, 2014, 2015, 2016, 2017];

    // Prepare data for stacking
    const regionNames = ["northeast", "midwest", "south", "west"];
    const stackedData = d3.stack()
        .keys(regionNames)
        .value((d, key) => {
            const region = regionData[key] || [];
            const yearData = region.find(r => r.year === d.year);
            return yearData ? yearData.avgRate : 0;
        })
        (all_years);

    // Set up scales
    const x_scale = d3.scaleBand()
        .domain(all_years)
        .range([margin.left, svgWidth - margin.right])
        .padding(0.05);

    const y_scale = d3.scaleLinear()
        .domain([0, d3.max(stackedData[stackedData.length - 1], d => d[1])])
        .range([svgHeight - margin.bottom, margin.top]);

    const colorScale = d3.scaleOrdinal(d3.schemeCategory10);

    // Create the area generator
    const area = d3.area()
        .x(d => x_scale(d.data.year))
        .y0(d => y_scale(d[0]))
        .y1(d => y_scale(d[1]));

    // Create the layers (regions) for the streamgraph
    svg.selectAll(".layer")
        .data(stackedData)
        .enter().append("path")
        .attr("class", "layer")
        .attr("d", area)
        .attr("fill", (d, i) => colorScale(i));

    // Add x-axis (Years)
    svg.append("g")
        .attr("transform", `translate(0, ${svgHeight - margin.bottom})`)
        .call(d3.axisBottom(x_scale).tickValues(all_years.filter((year, i) => i % 2 === 0)))  // Every other year
        .style("font-family", "Courier New");

    // Add y-axis (Death Rate)
    svg.append("g")
        .attr("transform", `translate(${margin.left}, 0)`)
        .call(d3.axisLeft(y_scale).ticks(5))
        .style("font-family", "Courier New");

    // Add axis labels
    svg.append("text")
        .attr("x", svgWidth / 2)
        .attr("y", svgHeight - margin.bottom + 40)
        .style("text-anchor", "middle")
        .style("font-family", "Courier New")
        .text("Year");

    svg.append("text")
        .attr("x", -svgHeight / 2)
        .attr("y", margin.left / 2)
        .style("text-anchor", "middle")
        .style("font-family", "Courier New")
        .attr("transform", "rotate(-90)") // Rotate text to fit along the y-axis
        .text("Average Death Rate");
}


        function plotSmallMultiples(regionData) {
    const svg = d3.select("#ml_chart");

    // Define dimensions for each small chart
    const smallChartWidth = 340;
    const smallChartHeight = 500;
    const chartSpacing = 10; // Space between charts

    const numCharts = 4; // Number of regions
    const margin = 100; // To shift the whole chart to the right
    const svgWidth = 1400; // SVG width
    const svgHeight = smallChartHeight + 200; // SVG height (added space for labels)

    const regionNames = ["northeast", "midwest", "south", "west"];
    const all_years = [1999, 2000, 2001, 2002, 2003, 2004, 2005, 2006, 2007, 2008, 2009, 2010, 2011, 2012, 2013, 2014, 2015, 2016, 2017];

    // Set the x and y scales (same across all small multiples for consistency)
    const x_scale = d3.scaleBand()
        .domain(all_years)
        .range([0, smallChartWidth])
        .padding(0.1); // Adjust the padding to space out the bars

    const y_scale = d3.scaleLinear()
        .domain([0, d3.max(Object.values(regionData).flat(), d => d.avgRate)])
        .range([smallChartHeight - 50, 0]); // Adjusted for space at bottom

    // Create a line generator
    const line = d3.line()
        .x(d => x_scale(d.year))
        .y(d => y_scale(d.avgRate));

    // Set the SVG dimensions for the entire chart
    svg.attr("width", svgWidth)
        .attr("height", svgHeight);

    // Create each small chart (small multiples)
    regionNames.forEach((region, index) => {
        const regionDataForRegion = regionData[region];

        // Append a new group for each region's chart
        const g = svg.append("g")
            .attr("transform", `translate(${margin + index * (smallChartWidth + chartSpacing)}, 0)`); // Shift all charts to the right

        // Plot the line for this region
        g.append("path")
            .data([regionDataForRegion])
            .attr("class", "line")
            .attr("d", line)
            .attr("stroke", d3.schemeCategory10[index])
            .attr("fill", "none")
            .attr("stroke-width", 2);

        // Add the x-axis for each small chart, but label only every other year
        g.append("g")
            .attr("transform", `translate(0, ${smallChartHeight - 50})`)
            .call(d3.axisBottom(x_scale).tickValues(all_years.filter((year, i) => i % 2 === 0))) // Show every other year
            .style("font-family", "Courier New");

        // Add the y-axis only to the first chart (leftmost one)
        if (index === 0) {
            g.append("g")
                .call(d3.axisLeft(y_scale).ticks(5))
                .style("font-family", "Courier New");
        }

        // Add the region title (above each chart)
        g.append("text")
            .attr("x", smallChartWidth / 2)
            .attr("y", -10)
            .style("text-anchor", "middle")
            .style("font-family", "Courier New")
            .text(region.charAt(0).toUpperCase() + region.slice(1));

    });

    // Add a single label for the x-axis (shared across all small charts)
    svg.append("text")
        .attr("x", svgWidth / 2)
        .attr("y", smallChartHeight + 40)
        .style("text-anchor", "middle")
        .style("font-family", "Courier New")
        .text("Year");

    // Add a single label for the y-axis (shared across all small charts)
    svg.append("text")
        .attr("x", -svgHeight / 2 - 50)
        .attr("y", 20)
        .style("text-anchor", "middle")
        .style("font-family", "Courier New")
        .attr("transform", "rotate(-90)") // Rotate text to fit along the y-axis
        .text("Average Death Rate");


        svg.append("text")
        .attr("x", width/4)  // Centered label for the legend
        .attr("y", m_top - 100)  // Position above the color gradient
        .style("text-anchor", "middle")
        .style("font-family", "Courier New")
        .text("Northeast")

    
        svg.append("text")
        .attr("x", width/4 + 300)  // Centered label for the legend
        .attr("y", m_top - 100)  // Position above the color gradient
        .style("text-anchor", "middle")
        .style("font-family", "Courier New")
        .text("Midwest")

        svg.append("text")
        .attr("x", width/4 + 600)  // Centered label for the legend
        .attr("y", m_top - 100)  // Position above the color gradient
        .style("text-anchor", "middle")
        .style("font-family", "Courier New")
        .text("South")

        svg.append("text")
        .attr("x", width/4 + 900)  // Centered label for the legend
        .attr("y", m_top - 100)  // Position above the color gradient
        .style("text-anchor", "middle")
        .style("font-family", "Courier New")
        .text("West")
}


        function groupByRegion(data) {
            const regionData = {
                northeast: [],
                midwest: [],
                south: [],
                west: []
            };

            data.forEach(d => {
                let region = '';
                if (northeast.includes(d.state)) region = 'northeast';
                if (midwest.includes(d.state)) region = 'midwest';
                if (south.includes(d.state)) region = 'south';
                if (west.includes(d.state)) region = 'west';

                if (region) {
                    regionData[region].push(d);
                }
            });

            for (let region in regionData) {
                const yearGroup = d3.group(regionData[region], d => d.year);
                regionData[region] = Array.from(yearGroup, ([year, values]) => {
                    const avgRate = d3.mean(values, d => d.d_rate);
                    return { year, avgRate };
                });
            }

            return regionData;
        }

        function plotLineChart(regionData) {
    const svg = d3.select("#l_chart");
    const all_years = d3.range(1999, 2018); // Generates an array of years from 1999 to 2017

    // Scale for the x-axis (Years), using a point scale for categorical years
    const x_scale = d3.scalePoint()
        .domain(all_years) // Set domain to the array of years
        .range([m_left, width - m_right])
        .padding(0.1); // Add some padding between the points

    // Scale for the y-axis (Death Rates)
    const y_scale = d3.scaleLinear()
        .domain([0, d3.max(Object.values(regionData).flat(), d => d.avgRate)]) // Max death rate in the data
        .range([height - m_bottom, m_top]);

    // Color scale for lines representing regions
    const colorScale = d3.scaleOrdinal(d3.schemeCategory10);

    // Line generator function
    const line = d3.line()
        .x(d => x_scale(d.year)) // Map year to x-axis position (using x_scale)
        .y(d => y_scale(d.avgRate)); // Map death rate to y-axis position

    // Loop through each region and plot the lines
    Object.keys(regionData).forEach((region, i) => {
        // Plot line for each region
        svg.append("path")
            .data([regionData[region]]) // Data for the region
            .attr("class", "line")
            .attr("d", line)
            .attr("stroke", colorScale(i)) // Color based on the region index
            .attr("fill", "none")
            .attr("stroke-width", 2);

        // Add text label for the region
        svg.append("text")
            .attr("x", width - 150) // Position it near the end of the chart
            .attr("y", m_top + i * 20) // Vertically space the labels
            .attr("fill", colorScale(i)) // Same color as the line
            .style("font-family", "Courier New")
            .style("font-size", "14px")
            .text(region.charAt(0).toUpperCase() + region.slice(1)); // Capitalize first letter of region name
    });

    // Add the x-axis (year axis)
    svg.append("g")
        .attr("transform", `translate(0, ${height - m_bottom})`)
        .call(d3.axisBottom(x_scale)) // Use x_scale for categorical years
        .style("font-family", "Courier New");

    // Add the y-axis (death rate axis)
    svg.append("g")
        .attr("transform", `translate(${m_left}, 0)`)
        .call(d3.axisLeft(y_scale).ticks(5)) // Set number of ticks for y-axis
        .style("font-family", "Courier New");
    svg.append("text")
                .attr("x", (width / 2))
                .attr("y", m_top / 2 + 20)
                .attr("font-size", "18px")
                .attr("font-family", "Courier New")
                .attr("text-anchor", "middle")
                .text("Average rate of death from in the US regions from 1999 - 2017");

    // Add axis labels
    svg.append("text")
        .attr("x", width / 2)
        .attr("y", height - 50)
        .style("text-anchor", "middle")
        .style("font-family", "Courier New")
        .text("Year");

    svg.append("text")
        .attr("x", -height / 2)
        .attr("y", 20)
        .style("text-anchor", "middle")
        .style("font-family", "Courier New")
        .attr("transform", "rotate(-90)") // Rotate text to fit along the y-axis
        .text("Death Rate (per 100k population)");
}

function plotHeatmap(regionData) {
    const svg = d3.select("#h_map");

    // Set up color scale for the heatmap (original sequential color scheme for death rates)
    const colorScale = d3.scaleSequential(d3.interpolateYlOrRd)
        .domain([0, 25]); // Standard color scale

    const regionNames = ["northeast", "midwest", "south", "west"];
    const years = d3.range(1999, 2018); // Years 1999 to 2017

    const cellWidth = 50;
    const cellHeight = 50;

    svg.append("text")
        .attr("x", (width / 2))
        .attr("y", m_top / 2)
        .attr("font-size", "18px")
        .attr("font-family", "Courier New")
        .attr("text-anchor", "middle")
        .text("Average Rate of Death in US Regions (1999 - 2017)");

    // Create the heatmap grid (switch the axes)
    svg.selectAll("rect")
        .data(d3.cross(years, regionNames))  // Switch years and regions
        .enter().append("rect")
        .attr("x", d => m_left + (d[0] - 1999) * cellWidth) // Position cells by year
        .attr("y", d => m_top + regionNames.indexOf(d[1]) * cellHeight) // Position cells by region
        .attr("width", cellWidth)
        .attr("height", cellHeight)
        .attr("fill", d => {
            const region = regionData[d[1]] || [];
            const yearData = region.find(r => r.year === d[0]);
            return yearData ? colorScale(yearData.avgRate) : "#FFFFFF"; // Default to white if no data
        })
        .append("title")
        .text(d => {
            const region = regionData[d[1]] || [];
            const yearData = region.find(r => r.year === d[0]);
            return yearData ? `${d[0]}: ${yearData.avgRate.toFixed(2)} deaths per 100k` : `${d[0]}: No data`;
        });

    // Add text labels for years (x-axis)
    svg.append("g")
        .attr("transform", `translate(0, ${m_top + regionNames.length * cellHeight + 10})`)  // Position below heatmap
        .selectAll("text")
        .data(years)
        .enter().append("text")
        .attr("x", (d, i) => m_left + i * cellWidth + cellWidth / 2) // Center horizontally
        .attr("y", 0)
        .style("text-anchor", "middle")
        .style("font-family", "Courier New")
        .text(d => d);

    // Add text labels for regions (y-axis)
    svg.append("g")
        .attr("transform", `translate(${m_left - 45}, ${m_top - 150})`) // Position on the left
        .selectAll("text")
        .data(regionNames)
        .enter().append("text")
        .attr("x", 0)
        .attr("y", (d, i) => m_top + i * cellHeight + cellHeight / 2) // Center vertically
        .style("text-anchor", "middle")
        .style("font-family", "Courier New")
        .text(d => d.charAt(0).toUpperCase() + d.slice(1)); // Capitalize first letter of region

    // Add color legend (vertical)
    const legendWidth = 20;  // Width of the color legend rectangle
    const legendHeight = 200; // Height of the color legend rectangle

    const legend = svg.append("g")
        .attr("transform", `translate(${width - 100}, ${m_top})`);

    // Create a linear scale for the vertical legend
    const legendScale = d3.scaleLinear()
        .domain([0, d3.max(Object.values(regionData).flat(), d => d.avgRate)]) // Standard color scale domain
        .range([0, legendHeight]);  // Standard vertical gradient range

    // Create the color gradient for the legend (No changes, just standard interpolation)
    const gradient = svg.append("defs")
        .append("linearGradient")
        .attr("id", "gradient")
        .attr("x1", "0%")
        .attr("y1", "0%")
        .attr("x2", "0%")
        .attr("y2", "100%");

    gradient.append("stop")
        .attr("offset", "0%")
        .attr("stop-color", d3.interpolateYlOrRd(0));  // Light yellow (low rates)

    gradient.append("stop")
        .attr("offset", "100%")
        .attr("stop-color", d3.interpolateYlOrRd(1));  // Dark red (high rates)

    // Add a rectangle for the vertical color gradient
    svg.append("rect")
        .attr("x", width - 100)  // Position the legend at the right side of the heatmap
        .attr("y", m_top)  // Adjust the position from the top
        .attr("width", legendWidth)  // Width of the legend
        .attr("height", legendHeight)  // Height of the legend
        .style("fill", "url(#gradient)");  // Fill the rectangle with the gradient

    // Add a vertical axis for the legend
    const legendAxis = d3.axisRight(legendScale)
        .ticks(5) // Number of ticks on the axis
        .tickSize(10);

    legend.append("g")
        .attr("transform", `translate(${legendWidth}, 0)`)  // Position the axis next to the color gradient
        .call(legendAxis);

    // Add a label for the legend
    svg.append("text")
        .attr("x", width - 100 + legendWidth / 2)  // Centered label for the legend
        .attr("y", m_top - 10)  // Position above the color gradient
        .style("text-anchor", "middle")
        .style("font-family", "Courier New")
        .text("Death Rate");
;
}


        // Get today's date (for the top right corner)
        function get_date() {
            const date = new Date();
            const mm = String(date.getMonth() + 1).padStart(2, '0');
            const dd = String(date.getDate()).padStart(2, '0');
            const yy = String(date.getFullYear()).slice(-2);
            return `${mm}.${dd}.${yy}`;
        }

        // Set today's date in the HTML
        document.getElementById('date').textContent = get_date();
        load_data(); // Load and process data

    </script>
</body>
</html>
